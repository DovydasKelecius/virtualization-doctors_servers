---
- name: Deploy DB + Web + Client VMs from inside ansible-vm
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../vars_files/one_creds.yml      # encrypted with your single password
    - ../vars_files/sudo_pass.yml      # encrypted with the same password
  vars:
    inventory_file: /home/ansible/inventory.ini

  tasks:
    # Load the vault once – this creates the fact "opennebula_creds"
    - name: Load OpenNebula credentials
      include_vars:
        file: ../vars_files/one_creds.yml
        name: opennebula_creds
      no_log: true

    # ───── Initialize inventory ─────
    - name: Create clean inventory file
      copy:
        content: |
          [all:vars]
          ansible_user=ansible
          ansible_ssh_private_key_file=/home/ansible/.ssh/id_rsa
          ansible_ssh_common_args=-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null

        dest: "{{ inventory_file }}"
        force: yes

    # ───── Deploy the three VMs ─────
    # - name: Deploy DB VM
    #   include_tasks: deploy_one_vm.yml
    #   vars:
    #     creds: "{{ opennebula_creds }}"           # ← PASS THE VAULT
    #     vm_base: db
    #     vm_name: rtfm_db
    #     template_id: 2975              # ← CHANGE TO YOUR REAL DB TEMPLATE ID
    #     group_name: db

    - name: Deploy Webserver VM
      include_tasks: deploy_one_vm.yml
      vars:
        creds: "{{ opennebula_creds }}"
        vm_base: webserver
        vm_name: rtfm_webserver
        template_id: 3013
        group_name: webserver

    - name: Deploy Client VM
      include_tasks: deploy_one_vm.yml
      vars:
        creds: "{{ opennebula_creds }}"          
        vm_base: client
        vm_name: rtfm_client
        template_id: 3015             
        group_name: client

    - name: Show final inventory
      command: cat "{{ inventory_file }}"
      register: result
    - debug:
        msg: "{{ result.stdout_lines }}"