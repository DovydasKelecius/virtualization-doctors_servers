- name: Configure Ansible VM to run Ansible on itself
  hosts: ansible
  become: true
  gather_facts: false # 1. SKIP GATHERING FACTS INITIALLY

  tasks:
    
    # --- PHASE 1: RAW BOOTSTRAP (No Python Required) ---
    # These tasks MUST come first and MUST use 'raw'.

    - name: 1. Ensure APT sources are correctly initialized
      ansible.builtin.raw: |
        # Back up and create new sources list
        sudo mv /etc/apt/sources.list /etc/apt/sources.list.bak
        # Use 'noble' for Ubuntu 22.04. Change to 'noble' if 24.04.
        sudo bash -c 'echo "deb http://archive.ubuntu.com/ubuntu/ noble main restricted universe multiverse" > /etc/apt/sources.list'
        sudo bash -c 'echo "deb http://archive.ubuntu.com/ubuntu/ noble-updates main restricted universe multiverse" >> /etc/apt/sources.list'
        sudo bash -c 'echo "deb http://security.ubuntu.com/ubuntu/ noble-security main restricted universe multiverse" >> /etc/apt/sources.list'
      changed_when: true

    - name: 2. üêç Install Python & Security Tools (Critical)
      ansible.builtin.raw: sudo apt update && sudo apt install -y python3 python3-minimal ca-certificates gnupg2
      changed_when: true

    # --- PHASE 2: STABILIZE SYSTEM (Python is now available) ---
    
    - name: 3. Gather facts now that Python is installed
      ansible.builtin.setup:

    - name: 4. Aggressively resolve system dependency conflicts
      ansible.builtin.apt:
        upgrade: dist 
        autoremove: yes
        update_cache: yes
      changed_when: true

    # --- PHASE 3: APPLICATION SETUP ---

    - name: 5. Install system dependencies
      ansible.builtin.apt:
        name:
          - curl
          - wget
          - git
          - jq
          - sshpass
          - python3-setuptools
          - python3-pip
          - python3-venv
          - sudo
        state: present
        update_cache: no # Cache was updated in the previous task

    - name: 6. Install Ansible
      ansible.builtin.apt:
        name: ansible
        state: present

    - name: 7. Ensure Python virtual environment exists
      ansible.builtin.command:
        cmd: python3 -m venv /home/ansible/.venv
        creates: /home/ansible/.venv
      become: true
      become_user: ansible 

    - name: 8. Install OpenNebula Python API (pyone) into VENV
      ansible.builtin.pip:
        name: pyone
        state: present
        virtualenv: /home/ansible/.venv
      become: true
      become_user: ansible

    - name: 9. Copy Mitogen directory from local machine to VM
      ansible.builtin.synchronize:
        src: "../mitogen-0.3.30/" 
        dest: "/home/ansible/mitogen-0.3.30"
        mode: push
        owner: yes
        group: yes
      become: true
      become_user: ansible