---
- name: Cleanup OpenNebula VMs - OpenNebula 4.14.2 compatible
  hosts: localhost
  gather_facts: false
  become: false

  vars:
    project_root: "{{ playbook_dir | dirname }}"
    api_url: "https://grid5.mif.vu.lt/cloud3/RPC2"
    vms_file: "{{ playbook_dir }}/tmp/opennebula_deployed_vms.json"   # <-- fixed path
    one_creds_file: "{{ project_root }}/vars_files/one_creds.yml"

  tasks:

    - name: Load credentials
      ansible.builtin.include_vars:
        file: "{{ one_creds_file }}"
        name: one_creds

    - name: Verify credentials loaded
      ansible.builtin.assert:
        that: one_creds.opennebula_accounts is defined
        fail_msg: "opennebula_accounts not found in {{ one_creds_file }}"

    - name: Load VM list from JSON
      ansible.builtin.set_fact:
        vms_to_delete: "{{ lookup('ansible.builtin.file', vms_file) | from_json }}"

    - name: Show how many VMs will be deleted
      ansible.builtin.debug:
        msg: "Found {{ vms_to_delete | length }} VM(s) to delete - IDs: {{ vms_to_delete | map(attribute='id') | join(', ') }}"

    - name: Delete each VM with any available account
      ansible.builtin.include_tasks: delete_one_vm.yml
      loop: "{{ vms_to_delete }}"
      loop_control:
        loop_var: vm
        label: "VM {{ vm.id }} - {{ vm.name }}"
      vars:
        current_vm: "{{ vm }}"

    - name: All done
      ansible.builtin.debug:
        msg: "Cleanup completed - all VMs permanently deleted"

     