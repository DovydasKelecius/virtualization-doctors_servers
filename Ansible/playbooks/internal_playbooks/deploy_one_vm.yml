---
# ------------------------------------------------------------------
# 1. Credentials & ID Extraction
# ------------------------------------------------------------------
- name: Load credentials for {{ vm_base }}
  set_fact:
    one_user: "{{ creds.opennebula_accounts[vm_base].user }}"
    one_pass: "{{ creds.opennebula_accounts[vm_base].password }}"
    target_user: "{{ vm_base }}" 

- name: Create VM {{ vm_name }}
  community.general.one_vm:
    api_url: "https://grid5.mif.vu.lt/cloud3/RPC2"
    api_username: "{{ one_user }}"
    api_password: "{{ one_pass }}"
    template_id: "{{ template_id }}"
    mode: 600
    state: present
    attributes:
      NAME: "{{ vm_name }}"
  register: vm_create
  retries: 3
  delay: 10
  until: vm_create is succeeded

- name: Extract VM ID
  set_fact:
    vm_id: "{{ vm_create.instances[0].vm_id }}"

# ------------------------------------------------------------------
# 2. Polling for Networking
# ------------------------------------------------------------------
- name: Wait for VM to be RUNNING and have Public IP
  community.general.one_vm:
    api_url: "https://grid5.mif.vu.lt/cloud3/RPC2"
    api_username: "{{ one_user }}"
    api_password: "{{ one_pass }}"
    instance_ids: "{{ vm_id }}"
    state: present
  register: vm_poll
  until: >
    vm_poll.instances[0].state == "ACTIVE" and
    vm_poll.instances[0].lcm_state == "RUNNING" and
    (
      vm_poll.instances[0].attributes.PUBLIC_IP is defined and
      vm_poll.instances[0].attributes.TCP_PORT_FORWARDING is defined
    )
  retries: 60
  delay: 10

- name: Extract connection details
  set_fact:
    external_ip: "{{ vm_poll.instances[0].attributes.PUBLIC_IP }}"
    internal_ip: "{{ vm_poll.instances[0].attributes.PRIVATE_IP }}"
    # Robustly extract the port (handles spaces/formatting issues)
    ssh_port: "{{ vm_poll.instances[0].attributes.TCP_PORT_FORWARDING.split(':')[0] | trim }}"

- name: Debug Connection
  debug: 
    msg: "Target: {{ internal_ip }} (External: {{ external_ip }}:{{ ssh_port }})"

# ------------------------------------------------------------------
# 3. Wait for SSH availability
# ------------------------------------------------------------------
- name: Wait for SSH port to be open
  ansible.builtin.wait_for:
    host: "{{ internal_ip }}"
    port: 22
    state: started
    timeout: 300
    delay: 10
  delegate_to: localhost

# ------------------------------------------------------------------
# 4. The Injection -> Key Setup
# ------------------------------------------------------------------
- name: Add temp host for injection (Using Default Password)
  add_host:
    name: "temp_{{ vm_name }}"
    ansible_host: "{{ internal_ip }}"
    ansible_user: "{{ vm_base }}"
    # !!! CHANGE THIS IF YOUR TEMPLATE PASSWORD IS NOT 'password' !!!
    ansible_ssh_pass: "{{ vm_base }}"
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'

# We create the specific user (e.g. 'db', 'client') and add the key to them
- name: Setup User and Keys on {{ vm_name }}
  delegate_to: "temp_{{ vm_name }}"
  block:
    - name: Create user {{ target_user }} if it doesn't exist
      ansible.builtin.user:
        name: "{{ target_user }}"
        shell: /bin/bash
        state: present
        groups: sudo 
        append: yes

    - name: Inject SSH Key for {{ target_user }}
      ansible.posix.authorized_key:
        user: "{{ target_user }}"
        state: present
        key: "{{ lookup('file', '/home/ansible/.ssh/id_rsa.pub') }}"

    - name: Inject SSH Key for "{{ vm_base }}" (Backup access)
      ansible.posix.authorized_key:
        user: "{{ vm_base }}"
        state: present
        key: "{{ lookup('file', '/home/ansible/.ssh/id_rsa.pub') }}"

    

# ------------------------------------------------------------------
# 5. Final Inventory Update
# ------------------------------------------------------------------
- name: Ensure group header exists
  lineinfile:
    path: "{{ inventory_file }}"
    line: "[{{ group_name }}]"
    create: yes
    insertafter: EOF

- name: Add host to inventory file
  lineinfile:
    path: "{{ inventory_file }}"
    insertafter: "\\[{{ group_name }}\\]"
    line: "{{ internal_ip }} ansible_user={{ target_user }} ansible_ssh_pass={{ vm_base }}"

- name: Ensure group header for public_inventory exists
  lineinfile:
    path: "{{ public_inventory_file }}"
    line: "[{{ group_name }}]"
    create: yes
    insertafter: EOF

- name: Add to public inventory file
  lineinfile:
    path: "{{ public_inventory_file }}"
    insertafter: "\\[{{ group_name }}\\]"
    line: "{{ external_ip }} ansible_port={{ ssh_port }} ansible_user={{ target_user }} ansible_ssh_pass={{ vm_base }}"

- name: Add to current in-memory inventory
  add_host:
    name: "{{ vm_name }}"
    groups: "{{ group_name }}"
    ansible_host: "{{ internal_ip }}"
    ansible_user: "{{ target_user }}"

- name: Install python3 on {{ vm_name }} (works even with password-protected sudo)
  delegate_to: localhost
  shell: >-
    sshpass -p "{{ target_user }}" ssh
    -o StrictHostKeyChecking=no
    -o UserKnownHostsFile=/dev/null
    {{ target_user }}@{{ internal_ip }}
    "echo '{{ target_user }}' | sudo -S DEBIAN_FRONTEND=noninteractive apt update &&
     echo '{{ target_user }}' | sudo -S DEBIAN_FRONTEND=noninteractive apt install -y python3"
  args:
    executable: /bin/bash
  changed_when: false
  environment:
    SSHPASS: "{{ target_user }}"