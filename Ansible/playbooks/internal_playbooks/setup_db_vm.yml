---
- name: Deploy PostgreSQL with hospital data
  hosts: db
  become: yes
  vars_files:
    - ../vars_files/sudo_pass.yml
    - ../vars_files/db_secrets.yml
    
  vars:
    ansible_become_pass: "{{ db_pass }}"
    db_vm_sql_dump_path: "/tmp/hospital_db_dump.sql" # Path inside the db-vm

  tasks:
    - name: "Add Docker apt repository"
      ansible.builtin.copy:
        content: |
          deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian bookworm stable
        dest: /etc/apt/sources.list.d/docker.list
        mode: '0644'
      tags: [docker]

    - name: Atnaujinti APT cache ir įdiegti dokerio priklausomybes
      ansible.builtin.apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - python3-pip
        state: present
        update_cache: yes
      tags: [docker]

    - name: Patikrinti, ar įdiegta community.docker
      ansible.builtin.command: ansible-galaxy collection list community.docker
      register: docker_collection_check
      ignore_errors: true
      changed_when: false
      delegate_to: localhost
      run_once: true
      tags: [docker]

    - name: Įdiegti community.docker, jei nėra
      ansible.builtin.command: ansible-galaxy collection install community.docker
      when: docker_collection_check.rc != 0
      delegate_to: localhost
      run_once: true
      tags: [docker]

    - name: Sukurti dir GPG raktams
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'
      tags: [docker]

    - name: Atsisiųsti docker GPG raktą
      ansible.builtin.get_url:
        url: https://download.docker.com/linux/debian/gpg

        dest: /etc/apt/keyrings/docker.asc
        mode: '0644'
      tags: [docker]

    - name: Konvertuoti GPG raktą į binary formatą
      ansible.builtin.command:
        cmd: gpg --dearmor -o /etc/apt/keyrings/docker.gpg /etc/apt/keyrings/docker.asc
        creates: /etc/apt/keyrings/docker.gpg
      tags: [docker]

    - name: Ištrinti ASCII formato GPG raktą
      ansible.builtin.file:
        path: /etc/apt/keyrings/docker.asc
        state: absent
      tags: [docker]


    - name: "Install docker"
      ansible.builtin.apt:
        pkg:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: latest
        update_cache: yes
      tags: [docker]

    - name: Įdiegti Docker SDK for Python
      ansible.builtin.apt:
        name: python3-docker
        state: present
      tags: [docker]

    - name: Užtikrinti, kad Docker service veikia
      service:
        name: docker
        state: started
        enabled: yes
      tags: [docker]

    - name: Sustabdyti ir pašalinti seną konteinerį
      community.docker.docker_container:
        name: hospital_db_container
        state: absent
      tags: [db]

    - name: Pašalinti seną docker volume
      community.docker.docker_volume:
        name: postgres_hospital_data
        state: absent
      tags: [db]

    - name: Nustatyti duomenų bazės kintamuosius
      set_fact:
        postgres_db: hospital
        postgres_user: hospital_owner
      tags: [db]

    - name: Paleisti PostgreSQL konteinerį
      community.docker.docker_container:
        name: hospital_db_container
        image: postgres:16
        state: started
        restart_policy: always
        env:
          POSTGRES_DB: "{{ postgres_db }}"
          POSTGRES_USER: "{{ postgres_user }}"
          POSTGRES_PASSWORD: "{{ postgres_password }}"
        ports:
          - "5432:5432"
        volumes:
          - "postgres_hospital_data:/var/lib/postgresql/data"
      tags: [db]

    - name: Palaukti, kol PostgreSQL priims prisijungimus
      wait_for:
        port: 5432
        delay: 10
        timeout: 60
        host: 127.0.0.1

      become: no
      tags: [db]

    - name: Kopijuoti SQL dump failą į db-vm
      ansible.builtin.copy:
        src: ../vars_files/hospital_20251108_185700.sql
        dest: "{{ db_vm_sql_dump_path }}"
        mode: '0644'
      tags: [db]

    - name: Importuoti SQL dump failą į PostgreSQL konteinerį
      ansible.builtin.shell: |
        docker exec -i hospital_db_container psql -U "{{ postgres_user }}" -d "{{ postgres_db }}" < "{{ db_vm_sql_dump_path }}"
      environment:
        PGPASSWORD: "{{ postgres_password }}"
      tags: [db]

    - name: Ištrinti SQL dump failą iš db-vm
      ansible.builtin.file:
        path: "{{ db_vm_sql_dump_path }}"
        state: absent
      tags: [db]
