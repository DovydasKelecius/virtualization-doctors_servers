- name: Deploy Ansible VM
  hosts: localhost
  become: false
  gather_facts: false
  vars_files:
    - ../vars_files/one_creds.yml
    - ../vars_files/sudo_pass.yml
  vars:
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
    ansible_become_pass: "{{ ansible_pass }}"
    vm_base: ansible
    vm_name: "rtfm_ansible"
    template_id: 2974
    max_wait_seconds: 600

  tasks:
    # ------------------------------------------------------------------
    # 0. PREP: Read Local Public Key
    # ------------------------------------------------------------------
    - name: Read local public SSH key
      set_fact:
        # Read the key file from your laptop
        local_ssh_pub_key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"

    # ------------------------------------------------------------------
    # 1. Load credentials
    # ------------------------------------------------------------------
    - name: Load vault
      include_vars:
        file: ../vars_files/one_creds.yml
        name: creds
      no_log: true

    - name: Set user/password
      set_fact:
        vm_user: "{{ creds.opennebula_accounts[vm_base].user }}"
        vm_password: "{{ creds.opennebula_accounts[vm_base].password }}"

    # ------------------------------------------------------------------
    # 2. Create VM (With Legacy Contextualization)
    # ------------------------------------------------------------------
    - name: Create VM
      community.general.one_vm:
        api_url: "https://grid5.mif.vu.lt/cloud3/RPC2"
        api_username: "{{ vm_user }}"
        api_password: "{{ vm_password }}"
        template_id: "{{ template_id }}"
        mode: 600
        state: present
        cpu: 0.3
        vcpu: 1
        memory: 1 GB
        disk_size: 4 GB
        attributes:
          NAME: "{{ vm_name }}"
      register: vm_create
      retries: 3
      delay: 10
      until: vm_create is succeeded

    - name: Wait until we can SSH
      ansible.builtin.wait_for_connection:
        timeout: 120
        delay: 5

    - name: Extract VM ID
      set_fact:
        vm_id: "{{ vm_create.instances[0].vm_id }}"

    # ------------------------------------------------------------------
    # 3. Poll VM until RUNNING
    # ------------------------------------------------------------------
    - name: Wait for VM to be RUNNING and have SSH port
      community.general.one_vm:
        api_url: "https://grid5.mif.vu.lt/cloud3/RPC2"
        api_username: "{{ vm_user }}"
        api_password: "{{ vm_password }}"
        instance_ids: "{{ vm_id }}"
        state: present
      register: vm_poll
      until: >
        vm_poll.instances[0].state == "ACTIVE" and
        vm_poll.instances[0].lcm_state == "RUNNING" and
        (
          vm_poll.instances[0].attributes.TCP_PORT_FORWARDING is defined or
          vm_poll.instances[0].attributes.GRAPHICS is defined
        )
      retries: "{{ (max_wait_seconds / 10) | int }}"
      delay: 10


    # ------------------------------------------------------------------
    # 4. Extract public access
    # ------------------------------------------------------------------
    - name: Extract IP and Port
      set_fact:
        external_ip: "{{ vm_poll.instances[0].attributes.PUBLIC_IP }}"
        ssh_port: >-
          {{
            (
              (
                vm_poll.instances[0].attributes.TCP_PORT_FORWARDING
                | default(vm_poll.instances[0].attributes.GRAPHICS.PORT | default('22'))
              )
              .split(':')[0]
              .split() | first
            )
            | int
          }}

    # ------------------------------------------------------------------
    # 5. Wait for SSH
    # ------------------------------------------------------------------
    - name: Wait for SSH port to be open
      ansible.builtin.wait_for:
        host: "{{ external_ip }}"
        port: "{{ ssh_port }}"
        state: started
        timeout: 180
        delay: 10
      delegate_to: localhost


    # ------------------------------------------------------------------
    # 6. Add to inventory
    # ------------------------------------------------------------------

    - name: Add host for initial password connection
      add_host:
        name: target_vm_temp
        ansible_host: "{{ external_ip }}"
        ansible_port: "{{ ssh_port }}"
        ansible_user: ansible
        ansible_ssh_pass: "ansible" 
        ansible_ssh_common_args: '-o StrictHostKeyChecking=no'

    - name: Push SSH Key to VM
      ansible.builtin.authorized_key:
        user: ansible
        state: present
        key: "{{ local_ssh_pub_key }}"
      delegate_to: target_vm_temp

    - name: Add to in-memory inventory
      add_host:
        name: ansible_vm
        ansible_host: "{{ external_ip }}"
        ansible_port: "{{ ssh_port }}"
        ansible_user: ansible 
        ansible_ssh_private_key_file: "~/.ssh/id_rsa"
        ansible_become_pass: "{{ ansible_sudo_pass }}"
        ansible_ssh_common_args: '-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'

    - name: Write inventory file
      copy:
        dest: ../inventory.ini
        content: |
          [ansible]
          {{ external_ip }} ansible_port={{ ssh_port }} ansible_user=ansible ansible_ssh_private_key_file=~/.ssh/id_rsa ansible_ssh_common_args='-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
        mode: '0644'